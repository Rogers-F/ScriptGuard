name: Build ScriptGuard

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£…Task CLI
        run: |
          choco install go-task -y
        shell: powershell

      - name: å®‰è£…Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest
        shell: powershell

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          npm install
        shell: powershell

      - name: å®‰è£…Goä¾èµ–
        run: |
          go mod tidy
          go mod download
        shell: powershell

      - name: å®‰è£… go-winres
        run: go install github.com/tc-hib/go-winres@latest
        shell: powershell

      - name: ç”Ÿæˆ Windows èµ„æºæ–‡ä»¶
        run: |
          Write-Host "=== å®‰è£… Pillow ==="
          python -m pip install --quiet pillow

          Write-Host "`n=== åˆ›å»º 256x256 å›¾æ ‡ ==="
          python -c "from PIL import Image; img = Image.open('build/appicon.png'); img.resize((256, 256), Image.Resampling.LANCZOS).save('build/appicon_256.png')"

          if (Test-Path "build/appicon_256.png") {
            Write-Host "âœ… 256x256 å›¾æ ‡åˆ›å»ºæˆåŠŸ"
          } else {
            Write-Host "âŒ 256x256 å›¾æ ‡åˆ›å»ºå¤±è´¥"
            exit 1
          }

          Write-Host "`n=== ç”Ÿæˆ .syso èµ„æºæ–‡ä»¶ ==="
          go-winres make --in winres.json --arch amd64 --out rsrc

          if (Test-Path "rsrc_windows_amd64.syso") {
            $size = (Get-Item "rsrc_windows_amd64.syso").Length
            Write-Host "âœ… .syso æ–‡ä»¶ç”ŸæˆæˆåŠŸ (å¤§å°: $($size / 1024) KB)"
          } else {
            Write-Host "âŒ .syso æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          }
        shell: powershell

      - name: éªŒè¯å›¾æ ‡èµ„æº
        run: |
          Write-Host "=== æ£€æŸ¥å›¾æ ‡æ–‡ä»¶ ==="
          if (Test-Path "build\windows\icon.ico") {
            Write-Host "âœ… icon.ico å­˜åœ¨"
            $size = (Get-Item "build\windows\icon.ico").Length
            Write-Host "   å¤§å°: $($size / 1024) KB"
          } else {
            Write-Host "âŒ icon.ico ä¸å­˜åœ¨"
            exit 1
          }

          if (Test-Path "build\appicon.png") {
            Write-Host "âœ… appicon.png å­˜åœ¨"
          } else {
            Write-Host "âŒ appicon.png ä¸å­˜åœ¨"
            exit 1
          }

          if (Test-Path "build\windows\info.json") {
            Write-Host "âœ… info.json å­˜åœ¨"
          } else {
            Write-Host "âŒ info.json ä¸å­˜åœ¨"
            exit 1
          }
        shell: powershell

      - name: æ„å»ºåº”ç”¨ï¼ˆä½¿ç”¨ Wailsï¼‰
        run: |
          Write-Host "=== ä½¿ç”¨ wails3 build å®Œæ•´æ„å»º ==="
          wails3 build

          Write-Host "`n=== æ£€æŸ¥æ„å»ºåçš„ bindings ==="
          if (Test-Path "frontend/bindings") {
            Write-Host "âœ… frontend/bindings å­˜åœ¨"
            Get-ChildItem -Path "frontend/bindings" -Recurse -File | Select-Object -First 20 | ForEach-Object {
              Write-Host "  - $($_.FullName.Replace('D:\a\ScriptGuard\ScriptGuard\', ''))"
            }
          } else {
            Write-Host "âŒ frontend/bindings ä¸å­˜åœ¨"
            exit 1
          }

          Write-Host "`n=== æŸ¥çœ‹ index.js å†…å®¹ ==="
          if (Test-Path "frontend/bindings/scriptguard/backend/index.js") {
            Get-Content "frontend/bindings/scriptguard/backend/index.js" | Select-Object -First 30
          }

          Write-Host "`n=== æŸ¥çœ‹ app.js å†…å®¹ ==="
          if (Test-Path "frontend/bindings/scriptguard/backend/app.js") {
            Get-Content "frontend/bindings/scriptguard/backend/app.js" | Select-Object -First 30
          }
        shell: powershell
        continue-on-error: true

      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          if (Test-Path "build/bin/ScriptGuard.exe") {
            Write-Host "Build successful!"
            $size = (Get-Item build/bin/ScriptGuard.exe).Length / 1MB
            Write-Host "File size: $size MB"
          } else {
            Write-Host "Build failed: ScriptGuard.exe not found"
            exit 1
          }
        shell: powershell

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ScriptGuard-Windows-x64
          path: build/bin/ScriptGuard.exe
          retention-days: 30

      - name: åˆ›å»ºReleaseï¼ˆä»…Tagè§¦å‘ï¼‰
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: build/bin/ScriptGuard.exe
          body: |
            ## ğŸ‰ ScriptGuard ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            1. ä¸‹è½½ `ScriptGuard.exe`
            2. åŒå‡»è¿è¡Œå³å¯
            3. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶

            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - Pythonè„šæœ¬å®šæ—¶æ‰§è¡Œ
            - Condaç¯å¢ƒéš”ç¦»
            - å®æ—¶æ—¥å¿—ç›‘æ§
            - æ‰§è¡Œå†å²åˆ†æ
            - é’‰é’‰/ä¼ä¸šå¾®ä¿¡å‘Šè­¦

            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (64-bit)
            - Anaconda æˆ– Miniconda

            ### ğŸ“– è¯¦ç»†æ–‡æ¡£
            è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šLinuxæ„å»ºï¼ˆå¦‚æœéœ€è¦è·¨å¹³å°ï¼‰
  # build-linux:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkoutä»£ç 
  #       uses: actions/checkout@v4
  #     # ... ç±»ä¼¼Windowsçš„æ­¥éª¤
