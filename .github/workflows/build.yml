name: Build ScriptGuard

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£…Task CLI
        run: |
          choco install go-task -y
        shell: powershell

      - name: å®‰è£…Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@v3.0.0-alpha.7
        shell: powershell

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          npm install
        shell: powershell

      - name: å®‰è£…Goä¾èµ–
        run: |
          go mod tidy
          go mod download
        shell: powershell

      - name: ç”Ÿæˆç»‘å®šä»£ç 
        run: |
          Write-Host "=== å½“å‰ç›®å½• ==="
          Get-Location
          Write-Host "`n=== è¿è¡Œ wails3 generate bindings ==="
          wails3 generate bindings
          Write-Host "`n=== æ£€æŸ¥æ ¹ç›®å½•ä¸‹çš„ bindings ==="
          if (Test-Path "bindings") {
            Write-Host "æ ¹ç›®å½• bindings å­˜åœ¨"
            Get-ChildItem -Path "bindings" -Recurse | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "æ ¹ç›®å½• bindings ä¸å­˜åœ¨"
          }
          Write-Host "`n=== æ£€æŸ¥ frontend/bindings ==="
          if (Test-Path "frontend/bindings") {
            Write-Host "frontend/bindings å­˜åœ¨"
            Get-ChildItem -Path "frontend/bindings" -Recurse | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "frontend/bindings ä¸å­˜åœ¨"
          }
          Write-Host "`n=== æ£€æŸ¥ frontend ä¸‹æ‰€æœ‰ç›®å½• ==="
          Get-ChildItem -Path "frontend" -Directory | ForEach-Object { Write-Host $_.Name }
        shell: powershell
        continue-on-error: true

      - name: æ‰‹åŠ¨å¤åˆ¶ç»‘å®šæ–‡ä»¶ï¼ˆå¦‚æœåœ¨æ ¹ç›®å½•ï¼‰
        run: |
          if (Test-Path "bindings") {
            Write-Host "å‘ç°æ ¹ç›®å½• bindingsï¼Œå¤åˆ¶åˆ° frontend/"
            Copy-Item -Path "bindings" -Destination "frontend/bindings" -Recurse -Force
          }
        shell: powershell
        continue-on-error: true

      - name: æ„å»ºå‰ç«¯
        run: |
          cd frontend
          npm run build
        shell: powershell

      - name: æ„å»ºåç«¯
        run: go build -o build/bin/ScriptGuard.exe -ldflags="-w -s" .
        shell: powershell

      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          if (Test-Path "build/bin/ScriptGuard.exe") {
            Write-Host "âœ… æ„å»ºæˆåŠŸï¼"
            Write-Host "æ–‡ä»¶å¤§å°: $((Get-Item build/bin/ScriptGuard.exe).Length / 1MB) MB"
          } else {
            Write-Host "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°exeæ–‡ä»¶"
            exit 1
          }
        shell: powershell

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ScriptGuard-Windows-x64
          path: build/bin/ScriptGuard.exe
          retention-days: 30

      - name: åˆ›å»ºReleaseï¼ˆä»…Tagè§¦å‘ï¼‰
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/bin/ScriptGuard.exe
            README.md
            config/app.yaml
          body: |
            ## ğŸ‰ ScriptGuard ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            1. ä¸‹è½½ `ScriptGuard.exe`
            2. åŒå‡»è¿è¡Œå³å¯
            3. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶

            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - Pythonè„šæœ¬å®šæ—¶æ‰§è¡Œ
            - Condaç¯å¢ƒéš”ç¦»
            - å®æ—¶æ—¥å¿—ç›‘æ§
            - æ‰§è¡Œå†å²åˆ†æ
            - é’‰é’‰/ä¼ä¸šå¾®ä¿¡å‘Šè­¦

            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (64-bit)
            - Anaconda æˆ– Miniconda

            ### ğŸ“– è¯¦ç»†æ–‡æ¡£
            è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šLinuxæ„å»ºï¼ˆå¦‚æœéœ€è¦è·¨å¹³å°ï¼‰
  # build-linux:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkoutä»£ç 
  #       uses: actions/checkout@v4
  #     # ... ç±»ä¼¼Windowsçš„æ­¥éª¤
