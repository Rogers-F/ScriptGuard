name: Build ScriptGuard

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£…Task CLI
        run: |
          choco install go-task -y
        shell: powershell

      - name: å®‰è£…Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest
        shell: powershell

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          npm install
        shell: powershell

      - name: å®‰è£…Goä¾èµ–
        run: |
          go mod tidy
          go mod download
        shell: powershell

      - name: ç”Ÿæˆåº”ç”¨èµ„æº
        run: |
          Write-Host "=== ç”Ÿæˆå¹³å°å›¾æ ‡ ==="
          cd build
          if (-not (Test-Path "windows\icon.ico")) {
            Write-Host "âš ï¸ icon.ico ä¸å­˜åœ¨ï¼Œå°è¯•ç”Ÿæˆ..."
            cd ..
            # wails3 generate icons å‘½ä»¤åœ¨ CI ç¯å¢ƒå¯èƒ½æœ‰é—®é¢˜ï¼Œä½¿ç”¨å·²æäº¤çš„å›¾æ ‡
          } else {
            Write-Host "âœ… icon.ico å·²å­˜åœ¨"
          }

          Write-Host "`n=== æ›´æ–°æ„å»ºèµ„æº ==="
          cd ..
          # wails3 update build-assets åœ¨ CI å¯èƒ½ä¸éœ€è¦ï¼ŒWails ä¼šè‡ªåŠ¨å¤„ç†
        shell: powershell
        continue-on-error: true

      - name: æ„å»ºåº”ç”¨ï¼ˆä½¿ç”¨ Wailsï¼‰
        run: |
          Write-Host "=== ä½¿ç”¨ wails3 build å®Œæ•´æ„å»º ==="
          wails3 build

          Write-Host "`n=== æ£€æŸ¥æ„å»ºåçš„ bindings ==="
          if (Test-Path "frontend/bindings") {
            Write-Host "âœ… frontend/bindings å­˜åœ¨"
            Get-ChildItem -Path "frontend/bindings" -Recurse -File | Select-Object -First 20 | ForEach-Object {
              Write-Host "  - $($_.FullName.Replace('D:\a\ScriptGuard\ScriptGuard\', ''))"
            }
          } else {
            Write-Host "âŒ frontend/bindings ä¸å­˜åœ¨"
            exit 1
          }

          Write-Host "`n=== æŸ¥çœ‹ index.js å†…å®¹ ==="
          if (Test-Path "frontend/bindings/scriptguard/backend/index.js") {
            Get-Content "frontend/bindings/scriptguard/backend/index.js" | Select-Object -First 30
          }

          Write-Host "`n=== æŸ¥çœ‹ app.js å†…å®¹ ==="
          if (Test-Path "frontend/bindings/scriptguard/backend/app.js") {
            Get-Content "frontend/bindings/scriptguard/backend/app.js" | Select-Object -First 30
          }
        shell: powershell
        continue-on-error: true

      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          if (Test-Path "build/bin/ScriptGuard.exe") {
            Write-Host "Build successful!"
            $size = (Get-Item build/bin/ScriptGuard.exe).Length / 1MB
            Write-Host "File size: $size MB"
          } else {
            Write-Host "Build failed: ScriptGuard.exe not found"
            exit 1
          }
        shell: powershell

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ScriptGuard-Windows-x64
          path: build/bin/ScriptGuard.exe
          retention-days: 30

      - name: åˆ›å»ºReleaseï¼ˆä»…Tagè§¦å‘ï¼‰
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: build/bin/ScriptGuard.exe
          body: |
            ## ğŸ‰ ScriptGuard ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            1. ä¸‹è½½ `ScriptGuard.exe`
            2. åŒå‡»è¿è¡Œå³å¯
            3. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶

            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - Pythonè„šæœ¬å®šæ—¶æ‰§è¡Œ
            - Condaç¯å¢ƒéš”ç¦»
            - å®æ—¶æ—¥å¿—ç›‘æ§
            - æ‰§è¡Œå†å²åˆ†æ
            - é’‰é’‰/ä¼ä¸šå¾®ä¿¡å‘Šè­¦

            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (64-bit)
            - Anaconda æˆ– Miniconda

            ### ğŸ“– è¯¦ç»†æ–‡æ¡£
            è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šLinuxæ„å»ºï¼ˆå¦‚æœéœ€è¦è·¨å¹³å°ï¼‰
  # build-linux:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkoutä»£ç 
  #       uses: actions/checkout@v4
  #     # ... ç±»ä¼¼Windowsçš„æ­¥éª¤
